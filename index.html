<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPA Calculator — Institution Evaluator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --ring: 0 0 0 3px rgba(99,102,241,.28); }
    .focus-ring:focus { outline: none; box-shadow: var(--ring); }
    th, td { white-space: nowrap; }
    .modal-open { overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen antialiased">
  <header class="max-w-6xl mx-auto px-4 sm:px-6 pt-8 pb-4">
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-3xl font-black tracking-tight text-indigo-700">GPA Calculator</h1>
        <p class="text-sm text-gray-600">Single-institution evaluator with retakes, modal picker, and local storage.</p>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <label class="text-sm font-medium text-gray-700" for="institution">Institution</label>
        <select id="institution" class="focus-ring rounded-xl border border-gray-300 bg-white px-3 py-2 text-sm">
          <option value="BYUI" selected>BYU–Idaho (2 d.p.)</option>
          <option value="Ensign">Ensign College (3 d.p.)</option>
          <option value="Pathway">Pathway (2 d.p.)</option>
        </select>
        <button id="clearAll" class="rounded-xl border border-red-200 text-red-700 hover:bg-red-50 px-3 py-2 text-sm">Clear All</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 pb-16">
    <!-- Summary Cards -->
    <section id="summary" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
      <div class="rounded-2xl bg-indigo-50 p-4 text-center ring-1 ring-indigo-100">
        <h3 class="text-indigo-700 font-semibold">Cumulative GPA</h3>
        <p id="cumGpa" class="text-3xl font-black text-indigo-900">0.00</p>
      </div>
      <div class="rounded-2xl bg-green-50 p-4 text-center ring-1 ring-green-100">
        <h3 class="text-green-700 font-semibold">Total Credits</h3>
        <p id="cumCredits" class="text-3xl font-black text-green-900">0</p>
      </div>
    </section>

    <!-- Terms Container -->
    <section class="space-y-8" id="terms"></section>

    <!-- Controls -->
    <div class="sticky bottom-4 mt-10 flex justify-center">
      <button id="addTerm" class="rounded-2xl bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-3 shadow-lg">+ Add Term</button>
    </div>
  </main>

  <!-- Row Template -->
  <template id="rowTemplate">
    <tr class="course-row">
      <td class="px-3 py-2">
        <div class="relative w-40 sm:w-48 md:w-56">
          <input type="text" placeholder="CSC 101" class="focus-ring w-full p-2 pr-10 border border-gray-300 rounded-lg bg-white text-gray-700 placeholder-gray-400 courseName" />
          <span class="retakeStar hidden absolute right-2 top-1/2 -translate-y-1/2 text-indigo-600 font-bold">**</span>
        </div>
      </td>
      <td class="px-3 py-2">
        <input type="number" min="0" step="0.5" placeholder="3" class="focus-ring w-24 p-2 border border-gray-300 rounded-lg bg-white text-gray-700 placeholder-gray-400 units" />
      </td>
      <td class="px-3 py-2">
        <select class="focus-ring w-28 p-2 border border-gray-300 rounded-lg bg-white text-gray-700 grade"></select>
      </td>
      <td class="px-3 py-2 text-center gradeVal font-semibold text-gray-800">0.00</td>
      <td class="px-3 py-2 text-center quality font-semibold text-gray-900">0.00</td>
      <td class="px-3 py-2">
        <div class="flex flex-col gap-1 text-xs sm:text-sm">
          <label class="flex items-center gap-2"><input type="checkbox" class="retakeToggle"> <span>Retake</span></label>
          <button class="chooseRetake hidden rounded-md border border-gray-300 px-2 py-1">Choose Course…</button>
        </div>
      </td>
      <td class="px-3 py-2 text-center">
        <button class="removeRow text-red-600 hover:text-red-800">Remove</button>
      </td>
    </tr>
  </template>

  <!-- Retake Modal -->
  <div id="retakeModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40" data-close="1"></div>
    <div class="absolute inset-x-0 top-10 mx-auto max-w-xl">
      <div class="bg-white rounded-2xl shadow-xl ring-1 ring-gray-200 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h3 class="font-semibold text-gray-800">Select earlier course to replace</h3>
          <button class="px-2 py-1 text-gray-500 hover:text-gray-700" data-close="1">✕</button>
        </div>
        <div class="max-h-80 overflow-y-auto" id="retakeList">
          <!-- options injected here -->
        </div>
        <div class="px-4 py-3 border-t text-right">
          <button class="rounded-lg px-3 py-2 border" data-close="1">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Fixed 4.0 scale with +/- and W/UW policy ---
    const SCALE = {
      letters: ['A','A-','B+','B','B-','C+','C','C-','D+','D','D-','F','UW','W'],
      points: { 'A':4.0,'A-':3.7,'B+':3.4,'B':3.0,'B-':2.7,'C+':2.4,'C':2.0,'C-':1.7,'D+':1.4,'D':1.0,'D-':0.7,'F':0.0,'UW':0.0,'W': null } // W excluded from GPA
    };

    const STORAGE_KEY = 'gpa_state_v2';

    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const termsEl   = $('#terms');
    const addTermBtn= $('#addTerm');
    const instSel   = $('#institution');

    const decimalsFor = () => instSel.value === 'Ensign' ? 3 : 2;
    const fmt = (n, d=decimalsFor()) => Number.isFinite(n) ? n.toFixed(d) : (0).toFixed(d);

    let nextRowId = 1;
    const genRowId = () => String(nextRowId++);

    // ----- Grade options
    function makeGradeSelectOptions(selectEl) {
      const letters = SCALE.letters;
      const current = selectEl.value;
      selectEl.innerHTML = '';
      for (const L of letters) {
        const opt = document.createElement('option');
        opt.value = L; opt.textContent = L; selectEl.appendChild(opt);
      }
      if (letters.includes(current)) selectEl.value = current; else selectEl.value = letters.at(-1);
    }

    // ----- Modal helpers
    const modalEl = $('#retakeModal');
    const modalList = $('#retakeList');
    let modalCtx = null; // { rowId, termIdx }

    function openRetakeModal(currentRow, termIdx) {
      // Build list of earlier rows
      modalList.innerHTML = '';
      const items = buildEarlierCourseOptions(termIdx, currentRow.dataset.rowId);
      if (items.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'px-4 py-6 text-sm text-gray-500';
        empty.textContent = 'No earlier courses available to replace.';
        modalList.appendChild(empty);
      } else {
        for (const {value, label} of items) {
          const btn = document.createElement('button');
          btn.className = 'w-full text-left px-4 py-3 hover:bg-gray-50 border-b';
          btn.textContent = label;
          btn.addEventListener('click', () => {
            setRetake(currentRow, value);
            closeRetakeModal();
          });
          modalList.appendChild(btn);
        }
      }
      modalCtx = { rowId: currentRow.dataset.rowId, termIdx };
      modalEl.classList.remove('hidden');
      document.body.classList.add('modal-open');
    }

    function closeRetakeModal() {
      modalEl.classList.add('hidden');
      document.body.classList.remove('modal-open');
      modalCtx = null;
    }

    modalEl.addEventListener('click', (e) => {
      if (e.target.dataset.close) closeRetakeModal();
    });

    // ----- Term + Row creation
    function createTermCard(index) {
      const wrapper = document.createElement('div');
      wrapper.className = 'term bg-white rounded-2xl shadow-sm ring-1 ring-gray-300 overflow-hidden';
      wrapper.dataset.termIndex = String(index);

      wrapper.innerHTML = `
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50">
          <div class="flex items-baseline gap-3">
            <h2 class="text-lg font-bold text-gray-800">Term <span class="term-number">${index}</span></h2>
            <span class="text-xs text-gray-700">Term GPA: <strong class="termGpa text-gray-900">${fmt(0)}</strong></span>
          </div>
          <div class="flex items-center gap-3">
            <button class="addCourse rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 text-sm">+ Add Course</button>
            <button class="removeTerm text-red-600 hover:text-red-800 text-sm">Remove Term</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-100 text-gray-700">
              <tr>
                <th class="px-3 py-2 text-left">Course</th>
                <th class="px-3 py-2 text-left">Units</th>
                <th class="px-3 py-2 text-left">Grade</th>
                <th class="px-3 py-2 text-center">Grade Value</th>
                <th class="px-3 py-2 text-center">Quality Points</th>
                <th class="px-3 py-2 text-left">Retake</th>
                <th class="px-3 py-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200" id="tbody-${index}"></tbody>
          </table>
        </div>
        <!-- Term Summary (no duplicate totals rows) -->
        <div class="px-4 py-4 bg-gray-50 border-t border-gray-200">
          <!-- Header -->
          <div class="grid grid-cols-12 gap-2 text-sm">
            <div class="col-span-3"></div>
            <div class="col-span-3 font-medium text-gray-600 text-center">Attempted</div>
            <div class="col-span-3 font-medium text-gray-600 text-center">Earned</div>
            <div class="col-span-3 font-medium text-gray-600 text-center">Quality Points</div>
          </div>
          <!-- Term GPA Row -->
          <div class="grid grid-cols-12 items-center mt-1">
            <div class="col-span-3 font-semibold text-gray-800">Term GPA: <span class="termGpa">${fmt(0)}</span></div>
            <div class="col-span-3 text-center termAttempted">0</div>
            <div class="col-span-3 text-center termEarned">0</div>
            <div class="col-span-3 text-center termQP">0</div>
          </div>
          <!-- Cum GPA Row -->
          <div class="grid grid-cols-12 items-center mt-3">
            <div class="col-span-3 font-semibold text-gray-800">Cum GPA: <span class="cumGpa">${fmt(0)}</span></div>
            <div class="col-span-3 text-center cumAttempted">0</div>
            <div class="col-span-3 text-center cumEarned">0</div>
            <div class="col-span-3 text-center cumQP">0</div>
          </div>
        </div>
      `;

      // seed with one row
      addCourseRow(wrapper);
      return wrapper;
    }

    function addCourseRow(termCard) {
      const tb = termCard.querySelector('tbody');
      const tpl = $('#rowTemplate');
      const tr = tpl.content.firstElementChild.cloneNode(true);
      tr.dataset.rowId = genRowId();
      const gradeSel = tr.querySelector('select.grade');
      makeGradeSelectOptions(gradeSel);
      tb.appendChild(tr);
      saveState();
      refreshRetakeMarks();
      return tr;
    }

    // Build list of earlier courses (for modal)
    function buildEarlierCourseOptions(currentTermIdx, currentRowId) {
      const opts = [];
      for (const t of $$('.term')) {
        const tIdx = Number(t.dataset.termIndex);
        if (tIdx >= currentTermIdx) break;
        for (const r of $$('.course-row', t)) {
          const rid = r.dataset.rowId;
          if (!rid || rid === currentRowId) continue;
          const name = $('.courseName', r)?.value?.trim() || '(Unnamed)';
          const units = parseFloat($('.units', r)?.value) || 0;
          const grade = $('.grade', r)?.value || '';
          const label = `Term ${tIdx} — ${name} [${units || 0}u, ${grade}]`;
          opts.push({ value: rid, label });
        }
      }
      return opts;
    }

    // ----- Retake plumbing
    function computeRetakeExclusionsMap() {
      const excludeFromTerm = {}; // rid -> startTermIdx
      for (const t of $$('.term')) {
        const termIdx = Number(t.dataset.termIndex);
        for (const r of $$('.course-row', t)) {
          const target = r.dataset.retakeOf;
          if (target) {
            // Only exclude if target is in an earlier term
            const targetRow = $$(`.course-row[data-row-id="${target}"]`).find(Boolean);
            if (!targetRow) continue;
            const targetTerm = Number(targetRow.closest('.term').dataset.termIndex);
            if (targetTerm < termIdx) {
              excludeFromTerm[target] = Math.min(excludeFromTerm[target] ?? termIdx, termIdx);
            }
          }
        }
      }
      return excludeFromTerm;
    }

    function setRetake(currentRow, targetRowId) {
      currentRow.dataset.retakeOf = targetRowId;
      $('.retakeToggle', currentRow).checked = true;
      refreshRetakeMarks();
      recalcAll();
      saveState();
    }

    function clearRetake(currentRow) {
      delete currentRow.dataset.retakeOf;
      $('.retakeToggle', currentRow).checked = false;
      refreshRetakeMarks();
      recalcAll();
      saveState();
    }

    function refreshRetakeMarks() {
      // Clear all marks
      $$('.course-row').forEach(r => $('.retakeStar', r).classList.add('hidden'));
      // Apply marks to both the earlier course and the retaking row
      for (const r of $$('.course-row')) {
        const target = r.dataset.retakeOf;
        if (!target) continue;
        const earlier = $$(`.course-row[data-row-id="${target}"]`).find(Boolean);
        if (!earlier) continue;
        $('.retakeStar', r).classList.remove('hidden');
        $('.retakeStar', earlier).classList.remove('hidden');
      }
    }

    // ----- Math
    function termCalc(termCard, excludeFromTermMap) {
      const rows = $$('.course-row', termCard);
      const termIdx = Number(termCard.dataset.termIndex);
      const map = SCALE.points;

      let attempted = 0, earned = 0, qp = 0;

      for (const r of rows) {
        const rid = r.dataset.rowId;
        const units = parseFloat($('.units', r).value) || 0;
        const grade = $('.grade', r).value;
        const gValRaw = map[grade];
        const gVal = gValRaw === null ? null : (gValRaw ?? 0);

        // Row UI
        const rowG = gVal === null ? '*' : gVal;
        $('.gradeVal', r).textContent = gVal === null ? '*' : fmt(rowG);
        const q = gVal === null ? 0 : (units * gVal);
        $('.quality', r).textContent = fmt(q);

        if (gVal === null) continue; // W doesn't count

        // Term aggregation (always counts its own term rows)
        attempted += units;
        qp += q;
        if (gVal > 0) earned += units;

        // Cache for cumulative phase
        r.__gpaRowCache = { units, gVal, q, rid, termIdx, exclusionStart: excludeFromTermMap[rid] };
      }

      const gpa = attempted > 0 ? qp / attempted : 0;
      // Update row in header and summary row
      termCard.querySelectorAll('.termGpa').forEach(el => el.textContent = fmt(gpa));
      $('.termAttempted', termCard).textContent = fmt(attempted);
      $('.termEarned', termCard).textContent = fmt(earned);
      $('.termQP', termCard).textContent = fmt(qp);

      return { attempted, earned, qp };
    }

    function computeCumMetrics(upToTermIdx) {
      let attempted = 0, earned = 0, qp = 0;
      for (const t of $$('.term')) {
        const tIdx = Number(t.dataset.termIndex);
        if (tIdx > upToTermIdx) break;
        for (const r of $$('.course-row', t)) {
          const c = r.__gpaRowCache; if (!c) continue;
          if (c.gVal === null) continue;
          const excludedNow = c.exclusionStart !== undefined && upToTermIdx >= c.exclusionStart;
          if (excludedNow) continue;
          attempted += c.units;
          qp += c.q;
          if (c.gVal > 0) earned += c.units;
        }
      }
      const gpa = attempted > 0 ? qp / attempted : 0;
      return { attempted, earned, qp, gpa };
    }

    function recalcAll() {
      const excludeFromTermMap = computeRetakeExclusionsMap();

      // Pass 1: compute per-term and cache rows
      const terms = $$('.term');
      terms.forEach(t => termCalc(t, excludeFromTermMap));

      // Pass 2: cumulative per term
      terms.forEach(t => {
        const tIdx = Number(t.dataset.termIndex);
        const { attempted, earned, qp, gpa } = computeCumMetrics(tIdx);
        $('.cumAttempted', t).textContent = fmt(attempted);
        $('.cumEarned', t).textContent = fmt(earned);
        $('.cumQP', t).textContent = fmt(qp);
        $('.cumGpa', t).textContent = fmt(gpa);
      });

      // Top summary is the last term's cumulative
      const lastIdx = terms.length ? Number(terms[terms.length - 1].dataset.termIndex) : 0;
      const top = computeCumMetrics(lastIdx);
      $('#cumGpa').textContent = fmt(top.gpa);
      $('#cumCredits').textContent = fmt(top.attempted);

      saveState();
    }

    function renumberTerms() {
      $$('.term').forEach((t, i) => {
        t.dataset.termIndex = String(i + 1);
        $('.term-number', t).textContent = String(i + 1);
      });
      refreshRetakeMarks();
    }

    // ----- Persistence
    function serializeState() {
      const state = {
        institution: instSel.value,
        nextRowId,
        terms: $$('.term').map(t => ({
          termIndex: Number(t.dataset.termIndex),
          rows: $$('.course-row', t).map(r => ({
            id: r.dataset.rowId,
            name: $('.courseName', r).value,
            units: parseFloat($('.units', r).value) || 0,
            grade: $('.grade', r).value,
            retakeOf: r.dataset.retakeOf || null,
          }))
        }))
      };
      return state;
    }

    function saveState() {
      const state = serializeState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function restoreState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return false;
      try {
        const state = JSON.parse(raw);
        instSel.value = state.institution || 'BYUI';
        nextRowId = state.nextRowId || 1;
        termsEl.innerHTML = '';
        for (const t of state.terms || []) {
          const termCard = createTermCard(t.termIndex);
          // clear the seeded row
          termCard.querySelector('tbody').innerHTML = '';
          for (const r of t.rows) {
            const tr = addCourseRow(termCard);
            tr.dataset.rowId = r.id; // preserve id
            $('.courseName', tr).value = r.name || '';
            $('.units', tr).value = r.units ?? '';
            $('.grade', tr).value = r.grade || 'W';
            if (r.retakeOf) tr.dataset.retakeOf = r.retakeOf;
          }
          termsEl.appendChild(termCard);
        }
        renumberTerms();
        refreshRetakeMarks();
        recalcAll();
        return true;
      } catch (e) {
        console.error('Failed to restore state', e);
        return false;
      }
    }

    // ----- Event Listeners
    addTermBtn.addEventListener('click', () => {
      const next = $$('.term').length + 1;
      const t = createTermCard(next);
      termsEl.appendChild(t);
      recalcAll();
    });

    termsEl.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      if (target.classList.contains('addCourse')) {
        const card = target.closest('.term');
        addCourseRow(card);
        recalcAll();
      }

      if (target.classList.contains('removeRow')) {
        const row = target.closest('tr');
        const tb = row?.parentElement;
        if (tb && tb.children.length > 1) {
          row.remove();
        } else {
          // keep at least one row; clear inputs
          row.querySelector('.courseName').value = '';
          row.querySelector('.units').value = '';
          const g = row.querySelector('.grade'); g.value = 'W';
          clearRetake(row);
        }
        renumberTerms();
        recalcAll();
      }

      if (target.classList.contains('removeTerm')) {
        const card = target.closest('.term');
        card.remove();
        renumberTerms();
        recalcAll();
      }

      if (target.classList.contains('chooseRetake')) {
        const row = target.closest('.course-row');
        const term = target.closest('.term');
        openRetakeModal(row, Number(term.dataset.termIndex));
      }
    });

    // Input changes
    termsEl.addEventListener('input', (e) => {
      const el = e.target;
      if (!(el instanceof HTMLElement)) return;
      if (el.matches('input, select')) {
        if (el.classList.contains('retakeToggle')) {
          const row = el.closest('.course-row');
          const chooseBtn = row.querySelector('.chooseRetake');
          if (el.checked) {
            chooseBtn.classList.remove('hidden');
            const term = el.closest('.term');
            openRetakeModal(row, Number(term.dataset.termIndex));
          } else {
            chooseBtn.classList.add('hidden');
            clearRetake(row);
          }
        }
        recalcAll();
      }
    });

    instSel.addEventListener('change', () => {
      recalcAll();
    });

    // Clear All
    $('#clearAll').addEventListener('click', () => {
      localStorage.removeItem(STORAGE_KEY);
      termsEl.innerHTML = '';
      seedDefaultTerms(3);
      instSel.value = 'BYUI';
      recalcAll();
    });

    // Seed
    function seedDefaultTerms(n=3) {
      for (let i=1; i<=n; i++) termsEl.appendChild(createTermCard(i));
    }

    // Boot
    if (!restoreState()) {
      seedDefaultTerms(3);
      // Prime grade selects
      $$('.grade').forEach(makeGradeSelectOptions);
      recalcAll();
    } else {
      // ensure selects options exist after restore
      $$('.grade').forEach(makeGradeSelectOptions);
      recalcAll();
    }
  </script>
</body>
</html>
